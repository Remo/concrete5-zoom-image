jQuery.fn.fancyZoom=function(e){function u(t){if(n){return false}o=$(this);n=true;var r=$(o.attr("href"));var u={width:window.innerWidth||window.document.documentElement.clientWidth||window.document.body.clientWidth,height:window.innerHeight||window.document.documentElement.clientHeight||window.document.body.clientHeight,x:window.pageXOffset||window.document.documentElement.scrollLeft||window.document.body.scrollLeft,y:window.pageYOffset||window.document.documentElement.scrollTop||window.document.body.scrollTop};var f=(e.width||r.width())+60;var l=(e.height||r.height())+60;if(o.data("limit-max-zoom")==="yes"){var c=Math.max(70,Math.min(f,u.width-60));var h=Math.max(70,Math.min(l,u.height-60));if(f>c||l>h){var p=f/l;if(p>c/h){f=c;l=Math.ceil(f/p)}else{l=h;f=Math.ceil(p*h)}}}var d=Math.max(u.height/2-l/2+u.y,0);var v=u.width/2-f/2;var m=t.pageY;var g=t.pageX;i.attr("curTop",m);i.attr("curLeft",g);i.attr("scaleImg",e.scaleImg?"true":"false");$("#zoom").hide().css({position:"absolute",top:m+"px",left:g+"px",width:"1px",height:"1px"});i.hide();if(e.closeOnClick){$("#zoom").click(a)}if(e.scaleImg){s.html(r.html());$("#zoom_content img").css("width","100%")}else{s.html("")}$("#zoom").animate({top:d+"px",left:v+"px",opacity:"show",width:f,height:l},500,null,function(){if(e.scaleImg!=true){s.html(r.html())}i.show();n=false});if(o.data("hide-original-on-zoom")==="yes"){o.data("fancyzoom.initial-visibility",o.css("visibility"));o.css("visibility","hidden")}return false}function a(){if(n){return false}n=true;$("#zoom").unbind("click");if(i.attr("scaleImg")!="true"){s.html("")}i.hide();$("#zoom").animate({top:i.attr("curTop")+"px",left:i.attr("curLeft")+"px",opacity:"hide",width:"1px",height:"1px"},500,null,function(){if(i.attr("scaleImg")=="true"){s.html("")}n=false;if(o.data("hide-original-on-zoom")==="yes"){o.css("visibility",o.data("fancyzoom.initial-visibility"));o.data("fancyzoom.initial-visibility",null)}});return false}function f(e){$("#zoom_table td").each(function(){var t=$(this).css("background-image").replace(/\.(png|gif|none)\"\)$/,"."+e+'")');$(this).css("background-image",t)});var t=i.children("img");var n=t.attr("src").replace(/\.(png|gif|none)$/,"."+e);t.attr("src",n)}e=e||{};var t=e&&e.directory?e.directory:"images";var n=false;if($("#zoom").length===0){var r="browser"in $&&$.browser.msie?"gif":"png";$("body").append(['<div id="zoom" style="display:none; position: relative; z-index: 900;">','<table id="zoom_table" style="border-collapse:collapse; width:100%; height:100%;">',"<tbody>","<tr>",'<td class="tl" style="background:url('+t+"/tl."+r+') 0 0 no-repeat; width:20px; height:20px; overflow:hidden;" />','<td class="tm" style="background:url('+t+"/tm."+r+') 0 0 repeat-x; height:20px; overflow:hidden;" />','<td class="tr" style="background:url('+t+"/tr."+r+') 100% 0 no-repeat; width:20px; height:20px; overflow:hidden;" />',"</tr>","<tr>",'<td class="ml" style="background:url('+t+"/ml."+r+') 0 0 repeat-y; width:20px; overflow:hidden;" />','<td class="mm" style="background:#fff; vertical-align:top; padding:10px;">','<div id="zoom_content">',"</div>","</td>",'<td class="mr" style="background:url('+t+"/mr."+r+') 100% 0 repeat-y; width:20px; overflow:hidden;" />',"</tr>","<tr>",'<td class="bl" style="background:url('+t+"/bl."+r+') 0 100% no-repeat; width:20px; height:20px; overflow:hidden;" />','<td class="bm" style="background:url('+t+"/bm."+r+') 0 100% repeat-x; height:20px; overflow:hidden;" />','<td class="br" style="background:url('+t+"/br."+r+') 100% 100% no-repeat; width:20px; height:20px; overflow:hidden;" />',"</tr>","</tbody>","</table>",'<a href="#" title="Close" id="zoom_close" style="position:absolute; top:0; left:0;">','<img src="'+t+"/closebox."+r+'" alt="Close" style="border:none; margin:0; padding:0;" />',"</a>","</div>",""].join(""));$("html").click(function(e){if($(e.target).parents("#zoom:visible").length===0)a()});$(document).keyup(function(e){if(e.keyCode==27&&$("#zoom:visible").length>0)a()});$("#zoom_close").click(a)}var i=$("#zoom_close");var s=$("#zoom_content");var o=null;this.each(function(){$($(this).attr("href")).hide();$(this).click(u)});return this}